<!DOCTYPE html>
<html itemtype="http://schema.org/Blog" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
    <meta
      content="width=device-width, initial-scale=1, maximum-scale=1"
      name="viewport"
    />
    <meta
      content="Martin Klepsch (martinklepsch@googlemail.com)"
      itemprop="author"
      name="author"
    />
    <meta
      content="blog, clojure, development, clojurescript, heroku, amazon s3, aws"
      itemprop="keywords"
      name="keywords"
    />
    <meta
      content="Personal Website and Blog of Martin Klepsch"
      itemprop="description"
      name="description"
    />
    <link href="https://martinklepsch.org/index.html" rel="canonical" />
    <title>Martin Klepsch</title>
    <meta content="Martin Klepsch" property="og:title" />
    <meta content="article" property="og:type" />
    <meta
      content="Personal Website and Blog of Martin Klepsch"
      property="og:description"
    />
    <meta content="https://martinklepsch.org/index.html" property="og:url" />
    <meta
      content="https://martinklepsch.org/images/selfies/1.jpg"
      property="og:image"
    />
    <meta content="martinklepsch.org" property="og:site_name" />
    <meta content="summary" name="twitter:card" />
    <meta content="@martinklepsch" name="twitter:site" />
    <meta content="@martinklepsch" name="twitter:creator" />
    <meta content="Martin Klepsch" name="twitter:title" />
    <meta
      content="Personal Website and Blog of Martin Klepsch"
      name="twitter:description"
    />
    <meta
      content="https://martinklepsch.org/images/selfies/1.jpg"
      name="twitter:image"
    />
    <link href="/images/favicon.ico" rel="shortcut icon" />
    <link
      href="/atom.xml"
      rel="alternate"
      title="Sitewide Atom Feed"
      type="application/atom+xml"
    />
    <link
      href="https://unpkg.com/basscss@8.0.2/css/basscss.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="/stylesheets/martinklepschorg-v3.css"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(["_setAccount", "UA-3138561-8"]);
      _gaq.push(["_setDomainName", "martinklepsch.org"]);
      _gaq.push(["_trackPageview"]);

      setTimeout("_gaq.push(['_trackEvent', '15_seconds', 'read'])", 15000);

      (function () {
        var ga = document.createElement("script");
        ga.type = "text/javascript";
        ga.async = true;
        ga.src =
          ("https:" == document.location.protocol
            ? "https://ssl"
            : "http://www") + ".google-analytics.com/ga.js";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body class="system-sans-serif dark-gray">
    <div class="mx1">
      <div class="max-width-3 mx-auto">
        <article
          class="mt4"
          itemprop="blogPost"
          itemscope=""
          itemtype="http://schema.org/BlogPosting"
        >
          <div class="h4 db mx-auto max-width-2">
            <a
              href="/posts/homoiconicity-and-feature-flags.html"
              title="Permalink: Homoiconicity &amp; Feature Flags"
              >Latest Post</a
            ><span class="px1">/</span
            ><a
              href="https://twitter.com/martinklepsch"
              title="@martinklepsch on Twitter"
              >@martinklepsch</a
            >
          </div>
          <h1 class="h3 bold w-80-ns lh-title max-width-2 mx-auto my3">
            Homoiconicity & Feature Flags
          </h1>
          <section class="mkdwn lh-copy">
            <p>
              At work we've been using feature flags to roll out various changes
              of the product. Most recently the rebrand from Icebreaker to
              <a href="https://gatheround.com">Gatheround</a>. This allowed us
              to continuously ship small pieces and review and improve these on
              their own pace without creating two vastly different branches of
              changes.
            </p>
            <p>
              With the rebrand work in particular there were lots of places
              where we needed relatively small, local differentiations between
              the old and the new appearance. Oftentimes just applying a
              different set of classes to a DOM element. Less often, up to
              swapping entire components.
            </p>
            <p>
              Overall this approach seemed to work really well and we shipped
              the rebrand without significant delays and at a level of quality
              that made everyone happy. What we're left with now is some 250+
              conditionals involving our <code>use-new-brand?</code> feature
              flag.
            </p>
            <p><em>This tells the story of how we got rid of those.</em></p>
            <h2>Introducing Homoiconicity</h2>
            <p>
              If you're well familiar with homoiconicity this may not be
              entirely new but for those who aren't: homoiconicity is the fancy
              word for when you can read your program as data. Among many other
              lisp/scheme languages Clojure is homoiconic:
            </p>
            <pre><code class="clojure">(doseq [n (range 10)]
  (println n))
</code></pre>
            <p>
              The program above can be run but it can also be read as multiple
              nested lists:
            </p>
            <pre><code class="clojure">[doseq     [n [range 10]]    [println n]]
</code></pre>
            <p>
              Now, if you know what I'm talking about you will see that I
              skipped over a small detail here, namely that the code above uses
              two types of parenthesis and that information got lost in this
              simplified array representation.
            </p>
            <p>
              When doing it right we would end up with exactly the same
              representation as in the first code sample. And that is
              homoiconicity.
            </p>
            <h2>Homoiconicity &amp; Feature Flags</h2>
            <p>
              With this basic understanding of homoiconicity, lets take a look
              at what those feature flags looked like in practice:
            </p>
            <pre><code class="clojure">[:div
 {:class (if (config/use-new-brand?)
           &quot;bg-new-brand typo-body&quot;
           &quot;bg-old-brand typo-large&quot;)}]
</code></pre>
            <pre><code class="clojure">(when (config/use-new-brand?)
  (icon/Icon {:name &quot;conversation-color&quot;
              :class &quot;prxxs h3&quot;}))
</code></pre>
            <p>
              And so on. Now we have 250+ of those in our codebase but don't
              really plan on reversing that change any time soon... so we got to
              get rid of them. Fortunately Clojure is homoiconic and doing this
              is possible in a fashion that really tickles my brain in a nice
              way.
            </p>
            <h2>Code Rewriting</h2>
            <p>
              ... isn't new of course, CircleCI famously
              <a
                href="https://circleci.com/blog/rewriting-your-test-suite-in-clojure-in-24-hours/"
                >rewrote 14.000 lines of test code to use a new testing
                framework</a
              >. I'm sure many others have done similar stuff and this general
              idea also isn't limited to Clojure. Code rewriting tools exist in
              many language ecosystems.
              <strong
                >But how easily you can do it in Clojure felt very
                empowering.</strong
              >
            </p>
            <p>
              The next two sections will be about some 30 lines of code got us
              there about 90% of the way.
            </p>
            <h2>Babashka + rewrite-clj</h2>
            <p>
              <a href="https://babashka.org/">Babashka</a> is a &quot;fast,
              native Clojure scripting runtime&quot;. With Babashka you can work
              with the filesystem with shell-like abstractions, make http
              requests and much more. You can't use every Clojure library from
              Babashka but many useful ones are included right out of the box.
            </p>
            <p>
              One of the libraries that is included is
              <a href="https://github.com/clj-commons/rewrite-clj"
                >rewrite-clj</a
              >. And, you guessed it, rewrite-clj helps you ü•Å ... rewrite
              Clojure/Script code.
            </p>
            <p>
              I hadn't used rewrite-clj before much am still a bit unfamiliar
              with it's API but after asking some questions on Slack
              <a href="https://twitter.com/borkdude">@borkdude</a> (who also
              created Babashka) helped me out with an example of transforming
              conditionals that I then adapted for my specific situation.
            </p>
            <p>
              I will not go into the code in detail here but if you're
              interested, I recorded
              <a
                href="https://www.loom.com/share/70c1d3c45d9f45e9833344b5bd076813"
                >a short 4 minute video explaining it at a surface level and
                demonstrating my workflow</a
              >.
            </p>
            <p>
              The rewriting logic showed in the video ignores many edge cases
              and isn't an attempt at an holistic tool to remove dead code
              branches but in our case this basic tool removed about 95% of the
              feature flag usages, leaving a mere 12 cases behind that used
              things like <code>cond-&gt;</code> or conjunctions.
            </p>
            <p>
              Of the more than 230 feature flags that have been removed only
              about ten needed additional adjustments for indentation. This
              happened mostly when a feature-flag-using conditional wrapped
              multiple lines of code. Due to the locality of our changes that
              (fortunately) was relatively uncommon. If we had set up an
              automatic formatter for our code this also wouldn't have required
              any extra work.
            </p>
            <h2>Onward</h2>
            <p>
              This has been an extremely satisfying project, if you can even
              call those 30 lines a &quot;project&quot;. I hope you also learned
              something or found it helpful in other ways!
            </p>
            <p>
              Thanks to
              <a href="https://github.com/sponsors/borkdude"
                >Michiel &quot;borkdude&quot; Borkent</a
              >
              for all his work on Babashka. The interactive development workflow
              shown in
              <a
                href="https://www.loom.com/share/70c1d3c45d9f45e9833344b5bd076813"
                >the video</a
              >
              paired with blazing startup times and a rich ecosystem makes it
              feel like there is a lot of potential still to be uncovered.
            </p>
            <p>
              I'd also like to thank
              <a href="https://github.com/lread">Lee Read</a>, who has done such
              an amazing job making rewrite-clj ready for more platforms like
              ClojureScript and Babashka as well as making sure it's
              future-proof by adding more tests and fixing many long standing
              bugs.
            </p>
            <p>
              After writing this blog post and detailing the beginnings of this
              idea I also took a bit more time
              <strong
                ><a
                  href="https://github.com/martinklepsch/prune-feature-flags.clj"
                  >to clean up the code and put it on GitHub</a
                ></strong
              >.
            </p>
            <p>
              If you thought this was interesting, consider
              <a href="https://twitter.com/martinklepsch"
                >following me on Twitter</a
              >!
            </p>
          </section>
        </article>
        <div class="my4 max-width-2 mx-auto">
          <section class="lh-copy">
            <h3 class="mb2">Other Posts</h3>
            <ol class="list-reset">
              <li class="mb2">
                <a class="h3 mr1" href="/posts/localizing-a-ghost-theme.html"
                  >Localizing a Ghost Theme</a
                ><span class="block h5">May 2021</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/clojure-macro-magic-vars-from-map.html"
                  >Clojure Macros: Creating vars from a map</a
                ><span class="block h5">February 2021</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/working-with-promises-in-clojurescript-repls.html"
                  >Promises in a ClojureScript REPL</a
                ><span class="block h5">May 2020</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/cljdoc-supports-foreign-libs.html"
                  >Improved Support for Foreign Libs in cljdoc</a
                ><span class="block h5">May 2020</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/static-blogging-lessons-learned.html"
                  >Static Blogging, Some Lessons Learned</a
                ><span class="block h5">May 2020</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/using-cljs-bean-to-wrap-firebase-documents.html"
                  >Working with Firebase Documents in ClojureScript</a
                ><span class="block h5">September 2019</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/writing-awesome-docstrings.html"
                  >4 Small Steps Towards Awesome Clojure Docstrings</a
                ><span class="block h5">January 2019</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/sustainable-open-source-current-efforts.html"
                  >Sustainable Open Source: Current Efforts</a
                ><span class="block h5">January 2018</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/maven-snapshots.html"
                  >Maven Snapshots</a
                ><span class="block h5">June 2017</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/requiring-closure-namespaces.html"
                  >Requiring Closure Namespaces</a
                ><span class="block h5">May 2017</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/simple-debouncing-in-clojurescript.html"
                  >Simple Debouncing in ClojureScript</a
                ><span class="block h5">April 2017</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/making-remote-work.html"
                  >Making Remote Work</a
                ><span class="block h5">March 2017</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/just-in-time-script-loading-with-react-and-clojuresript.html"
                  >Just-in-Time Script Loading With React And ClojureScript</a
                ><span class="block h5">November 2016</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/props-children-and-component-lifecycle-in-reagent.html"
                  >Props, Children & Component Lifecycle in Reagent</a
                ><span class="block h5">May 2016</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/om-next-reading-list.html"
                  >Om/Next Reading List</a
                ><span class="block h5">November 2015</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/parameterizing-clojurescript-builds.html"
                  >Parameterizing ClojureScript Builds</a
                ><span class="block h5">August 2015</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/clojurebridge-berlin.html"
                  >ClojureBridge Berlin</a
                ><span class="block h5">July 2015</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/managing-local-and-project-wide-development-parameters-in-leiningen.html"
                  >Managing Local and Project-wide Development Parameters in
                  Leiningen</a
                ><span class="block h5">June 2015</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/formal-methods-at-amazon.html"
                  >Formal Methods at Amazon</a
                ><span class="block h5">April 2015</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/lisp-keymap.html"
                  >(lisp keymap)</a
                ><span class="block h5">February 2015</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/cljsjs-use-javascript-libraries-in-clojurescript.html"
                  >CLJSJS - Use Javascript Libraries in Clojurescript With
                  Ease</a
                ><span class="block h5">January 2015</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/why-boot-is-relevant-for-the-clojure-ecosystem.html"
                  >Why Boot is Relevant For The Clojure Ecosystem</a
                ><span class="block h5">November 2014</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/s3-beam-direct-upload-to-s3-with-clojure-and-clojurescript.html"
                  >S3-Beam ‚Äî Direct Upload to S3 with Clojure & Clojurescript</a
                ><span class="block h5">October 2014</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/patalyze-an-experiment-exploring-patent-data.html"
                  >Patalyze &mdash; An Experiment Exploring Publicly Available
                  Patent Data</a
                ><span class="block h5">October 2014</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/running-a-clojure-uberjar-inside-docker.html"
                  >Running a Clojure Uberjar inside Docker</a
                ><span class="block h5">September 2014</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/using-coreasync-and-transducers-for-direct-s3-upload.html"
                  >Using core.async and Transducers to upload files from the
                  browser to S3</a
                ><span class="block h5">September 2014</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/emacs-and-vim.html"
                  >Emacs & Vim</a
                ><span class="block h5">July 2014</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/setting-up-your-own-little-heroku-with-dokku-and-digitalocean.html"
                  >Heroku-like Deployment With Dokku And DigitalOcean</a
                ><span class="block h5">March 2014</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/woodworking-masterclasses.html"
                  >Woodworking Masterclasses</a
                ><span class="block h5">February 2014</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/early-adopters-and-inverted-social-proof.html"
                  >Early Adopters And Inverted Social Proof</a
                ><span class="block h5">February 2014</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/living-small.html"
                  >Living Small</a
                ><span class="block h5">February 2014</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/telegram.html"
                  >Sending You a Telegram</a
                ><span class="block h5">January 2014</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/running-a-marathon-or-not.html"
                  >Running a Marathon, Or Not</a
                ><span class="block h5">January 2014</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/code-simplicity-review.html"
                  >Code Simplicity</a
                ><span class="block h5">January 2014</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/what-do-we-need-to-know.html"
                  >What do we need to know?</a
                ><span class="block h5">December 2013</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/sculleys-disease.html"
                  >Sculley's Disease</a
                ><span class="block h5">December 2013</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/a-resurrection-post.html"
                  >A Resurrection Post</a
                ><span class="block h5">December 2013</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/a-trip-to-the-us.html"
                  >A Trip To The US</a
                ><span class="block h5">September 2013</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/analytics-data.html"
                  >Analytics Data</a
                ><span class="block h5">April 2013</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/asynchronous-communication.html"
                  >Asynchronous Communication</a
                ><span class="block h5">April 2013</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/from-zero-to-marathon-in-six-months.html"
                  >From Zero to Marathon in Six Monthts</a
                ><span class="block h5">March 2013</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/git-prompt-for-fish-shell.html"
                  >Git Information in Fish Shell&rsquo;s Prompt</a
                ><span class="block h5">December 2012</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/when-we-build-stuff.html"
                  >When We Build Stuff</a
                ><span class="block h5">August 2012</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/models-operations-views-and-events.html"
                  >Models, Operations, Views and Events</a
                ><span class="block h5">July 2012</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/twelve-factor-app.html"
                  >The Twelve Factor App</a
                ><span class="block h5">June 2012</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/paris-and-back.html"
                  >Paris And Back</a
                ><span class="block h5">May 2012</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/a-friend-is-looking-for-a-summer-internship.html"
                  >A Friend Is Looking For A Summer Internship</a
                ><span class="block h5">May 2012</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/kandan-team-chat.html"
                  >Kandan Team Chat</a
                ><span class="block h5">May 2012</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/entypo-icon-set.html"
                  >Entypo Icon Set</a
                ><span class="block h5">March 2012</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/startups-this-is-how-design-works.html"
                  >Startups, This Is How Design Works</a
                ><span class="block h5">March 2012</span>
              </li>
              <li class="mb2">
                <a class="h3 mr1" href="/posts/hosting-a-static-site-on-s3.html"
                  >Hosting A Static Site On Amazon S3</a
                ><span class="block h5">February 2012</span>
              </li>
              <li class="mb2">
                <a
                  class="h3 mr1"
                  href="/posts/fix-broken-decoding-of-mail-subjects-in-exim.html"
                  >Exim4 Fix Wrongly Decoded Mail Subject</a
                ><span class="block h5">January 2012</span>
              </li>
            </ol>
          </section>
        </div>
      </div>
      <script>
        if (window.netlifyIdentity) {
          window.netlifyIdentity.on("init", (user) => {
            if (!user) {
              window.netlifyIdentity.on("login", () => {
                document.location.href = "/admin/";
              });
            }
          });
        }
      </script>
    </div>
  </body>
</html>
